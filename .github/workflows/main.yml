name: 🚀 Orderly Hello World Deployment

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'orderly-472413' }}
  GCP_REGION: asia-east1

jobs:
  # =============================================================================
  # BUILD AND TEST
  # =============================================================================
  build:
    name: 🏗️ Build & Test
    runs-on: ubuntu-latest
    outputs:
      frontend-image: ${{ steps.build-frontend.outputs.image }}
      api-gateway-image: ${{ steps.build-api-gateway.outputs.image }}
      user-service-image: ${{ steps.build-user-service.outputs.image }}
      product-service-image: ${{ steps.build-product-service.outputs.image }}
      acceptance-service-image: ${{ steps.build-acceptance-service.outputs.image }}
    steps:
      - name: 📦 Checkout code
        uses: actions/checkout@v4

      - name: 🏗️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🧪 Run tests (if available)
        run: npm run test --if-present

      - name: 🔍 Run linting (if available)
        run: npm run lint --if-present

      - name: 🧪 Test FastAPI Product Service
        run: |
          cd backend/product-service-fastapi
          pip install -r requirements.txt
          python -m pytest --version || echo "pytest not configured, skipping tests"

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: 🛠️ Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: 🐳 Configure Docker
        run: |
          gcloud auth configure-docker
          gcloud auth configure-docker asia-east1-docker.pkg.dev

      - name: 🏗️ Build Frontend Image (root Next.js)
        id: build-frontend
        run: |
          IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-frontend:${{ github.sha }}"
          docker build -f Dockerfile.frontend -t $IMAGE .
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: 🏗️ Build API Gateway Image
        id: build-api-gateway
        run: |
          IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-api-gateway-fastapi:${{ github.sha }}"
          docker build -f backend/api-gateway-fastapi/Dockerfile -t $IMAGE backend
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: 🏗️ Build User Service Image
        id: build-user-service
        run: |
          IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-user-service-fastapi:${{ github.sha }}"
          docker build -f backend/user-service-fastapi/Dockerfile -t $IMAGE backend
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: 🏗️ Build Product Service Image (FastAPI)
        id: build-product-service
        run: |
          IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-product-service-fastapi:${{ github.sha }}"
          docker build -f backend/product-service-fastapi/Dockerfile -t $IMAGE backend
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: 🏗️ Build Acceptance Service Image
        id: build-acceptance-service
        run: |
          IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-acceptance-service-fastapi:${{ github.sha }}"
          docker build -f backend/acceptance-service-fastapi/Dockerfile -t $IMAGE backend
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

  # =============================================================================
  # DEPLOY TO STAGING
  # =============================================================================
  deploy-staging:
    name: 🚧 Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging
    outputs:
      frontend-url: ${{ steps.deploy.outputs.frontend-url }}
      api-gateway-url: ${{ steps.deploy.outputs.api-gateway-url }}
      user-service-url: ${{ steps.deploy.outputs.user-service-url }}
      product-service-url: ${{ steps.deploy.outputs.product-service-url }}
      acceptance-service-url: ${{ steps.deploy.outputs.acceptance-service-url }}
    steps:
      - name: 📦 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: 🛠️ Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: 🚀 Deploy Services
        id: deploy
        run: |
          # Generate image URLs (same as build job)
          USER_SERVICE_IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-user-service-fastapi:${{ github.sha }}"
          API_GATEWAY_IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-api-gateway-fastapi:${{ github.sha }}"
          FRONTEND_IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-frontend:${{ github.sha }}"
          PRODUCT_SERVICE_IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-product-service-fastapi:${{ github.sha }}"
          ACCEPTANCE_SERVICE_IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-acceptance-service-fastapi:${{ github.sha }}"
          
          # Deploy User Service
          gcloud run deploy orderly-user-service-fastapi-staging \
            --image $USER_SERVICE_IMAGE \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 10 \
            --min-instances 0 \
            --port 8001 \
            --set-env-vars NODE_ENV=staging,JWT_SECRET=${{ secrets.JWT_SECRET || 'staging-jwt-secret' }},DATABASE_URL=${{ secrets.STAGING_DATABASE_URL || secrets.DATABASE_URL }}

          USER_SERVICE_URL=$(gcloud run services describe orderly-user-service-fastapi-staging --region=${{ env.GCP_REGION }} --format='value(status.url)')

          # Deploy Product Service (FastAPI)
          gcloud run deploy orderly-product-service-fastapi-staging \
            --image $PRODUCT_SERVICE_IMAGE \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 5 \
            --min-instances 0 \
            --port 3003 \
            --set-env-vars ENVIRONMENT=staging,DATABASE_URL=${{ secrets.STAGING_DATABASE_URL || secrets.DATABASE_URL }},LOG_LEVEL=INFO

          PRODUCT_SERVICE_URL=$(gcloud run services describe orderly-product-service-fastapi-staging --region=${{ env.GCP_REGION }} --format='value(status.url)')

          # Deploy Acceptance Service
          gcloud run deploy orderly-acceptance-service-fastapi-staging \
            --image $ACCEPTANCE_SERVICE_IMAGE \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 5 \
            --min-instances 0 \
            --port 8004 \
            --set-env-vars NODE_ENV=staging

          ACCEPTANCE_SERVICE_URL=$(gcloud run services describe orderly-acceptance-service-fastapi-staging --region=${{ env.GCP_REGION }} --format='value(status.url)')

          # Deploy API Gateway
          gcloud run deploy orderly-api-gateway-fastapi-staging \
            --image $API_GATEWAY_IMAGE \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10 \
            --min-instances 0 \
            --port 8000 \
            --set-env-vars NODE_ENV=staging,JWT_SECRET=${{ secrets.JWT_SECRET || 'staging-jwt-secret' }},USER_SERVICE_URL=$USER_SERVICE_URL,PRODUCT_SERVICE_URL=$PRODUCT_SERVICE_URL,ACCEPTANCE_SERVICE_URL=$ACCEPTANCE_SERVICE_URL/acceptance

          API_GATEWAY_URL=$(gcloud run services describe orderly-api-gateway-fastapi-staging --region=${{ env.GCP_REGION }} --format='value(status.url)')

          # Rebuild Frontend with runtime API base baked
          docker build -f Dockerfile.frontend --build-arg NEXT_PUBLIC_API_BASE_URL=$API_GATEWAY_URL/api -t $FRONTEND_IMAGE .
          docker push $FRONTEND_IMAGE

          # Deploy Frontend
          gcloud run deploy orderly-frontend-staging \
            --image $FRONTEND_IMAGE \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10 \
            --min-instances 0 \
            --port 8000 \
            --set-env-vars NODE_ENV=staging,ORDERLY_BACKEND_URL=$API_GATEWAY_URL,BACKEND_URL=$API_GATEWAY_URL,NEXT_PUBLIC_API_BASE_URL=$API_GATEWAY_URL/api

          FRONTEND_URL=$(gcloud run services describe orderly-frontend-staging --region=${{ env.GCP_REGION }} --format='value(status.url)')

          echo "frontend-url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "api-gateway-url=$API_GATEWAY_URL" >> $GITHUB_OUTPUT
          echo "user-service-url=$USER_SERVICE_URL" >> $GITHUB_OUTPUT
          echo "product-service-url=$PRODUCT_SERVICE_URL" >> $GITHUB_OUTPUT
          echo "acceptance-service-url=$ACCEPTANCE_SERVICE_URL" >> $GITHUB_OUTPUT

      - name: 🧪 Health Check
        run: |
          echo "Waiting for services to be ready..."
          sleep 30
          
          echo "🌐 Staging URLs:"
          echo "Frontend: ${{ steps.deploy.outputs.frontend-url }}"
          echo "API Gateway: ${{ steps.deploy.outputs.api-gateway-url }}"
          echo "User Service: ${{ steps.deploy.outputs.user-service-url }}"
          echo "Product Service: ${{ steps.deploy.outputs.product-service-url }}"
          echo "Acceptance Service: ${{ steps.deploy.outputs.acceptance-service-url }}"
          
          # Health checks
          curl -f "${{ steps.deploy.outputs.frontend-url }}/api/health" || exit 1
          curl -f "${{ steps.deploy.outputs.api-gateway-url }}/health" || exit 1
          # Additional probe for gateway compatibility
          curl -f "${{ steps.deploy.outputs.api-gateway-url }}/api/health" || exit 1
          curl -f "${{ steps.deploy.outputs.user-service-url }}/health" || exit 1
          curl -f "${{ steps.deploy.outputs.product-service-url }}/health" || exit 1
          curl -f "${{ steps.deploy.outputs.acceptance-service-url }}/acceptance/health" || exit 1

          # Gateway smoke checks (non-auth endpoints)
          echo "🔎 Gateway smoke: categories"
          curl -f "${{ steps.deploy.outputs.api-gateway-url }}/api/products/categories?includeProducts=false" --max-time 30 || exit 1
          echo "🔎 Gateway smoke: skus search"
          curl -f "${{ steps.deploy.outputs.api-gateway-url }}/api/products/skus/search?page_size=1" --max-time 30 || exit 1
          echo "🔎 Gateway smoke: hierarchy tree"
          curl -f "${{ steps.deploy.outputs.api-gateway-url }}/api/v2/hierarchy/tree" --max-time 30 || exit 1
          
          echo "✅ All staging services are healthy!"

  # =============================================================================
  # DEPLOY TO PRODUCTION
  # =============================================================================
  deploy-production:
    name: 🌟 Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    outputs:
      frontend-url: ${{ steps.deploy.outputs.frontend-url }}
      api-gateway-url: ${{ steps.deploy.outputs.api-gateway-url }}
      user-service-url: ${{ steps.deploy.outputs.user-service-url }}
    steps:
      - name: 📦 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: 🛠️ Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: 🚀 Deploy Services
        id: deploy
        run: |
          # Generate image URLs (same as build job)
          USER_SERVICE_IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-user-service-fastapi:${{ github.sha }}"
          API_GATEWAY_IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-api-gateway-fastapi:${{ github.sha }}"
          FRONTEND_IMAGE="asia-east1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly/orderly-frontend:${{ github.sha }}"
          
          # Deploy User Service
          gcloud run deploy orderly-user-service-fastapi-prod \
            --image $USER_SERVICE_IMAGE \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 2 \
            --max-instances 100 \
            --min-instances 1 \
            --port 8001 \
            --set-env-vars NODE_ENV=production,JWT_SECRET=${{ secrets.JWT_SECRET_PROD }}

          USER_SERVICE_URL=$(gcloud run services describe orderly-user-service-fastapi-prod --region=${{ env.GCP_REGION }} --format='value(status.url)')

          # Deploy API Gateway
          gcloud run deploy orderly-api-gateway-fastapi-prod \
            --image $API_GATEWAY_IMAGE \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 2Gi \
            --cpu 2 \
            --max-instances 100 \
            --min-instances 1 \
            --port 8000 \
            --set-env-vars NODE_ENV=production,JWT_SECRET=${{ secrets.JWT_SECRET_PROD }},USER_SERVICE_URL=$USER_SERVICE_URL

          API_GATEWAY_URL=$(gcloud run services describe orderly-api-gateway-fastapi-prod --region=${{ env.GCP_REGION }} --format='value(status.url)')

          # Deploy Frontend
          gcloud run deploy orderly-frontend-prod \
            --image $FRONTEND_IMAGE \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 2Gi \
            --cpu 2 \
            --max-instances 100 \
            --min-instances 1 \
            --port 8000 \
            --set-env-vars NODE_ENV=production,ORDERLY_BACKEND_URL=$API_GATEWAY_URL,BACKEND_URL=$API_GATEWAY_URL,NEXT_PUBLIC_API_BASE_URL=$API_GATEWAY_URL/api

          FRONTEND_URL=$(gcloud run services describe orderly-frontend-prod --region=${{ env.GCP_REGION }} --format='value(status.url)')

          echo "frontend-url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "api-gateway-url=$API_GATEWAY_URL" >> $GITHUB_OUTPUT
          echo "user-service-url=$USER_SERVICE_URL" >> $GITHUB_OUTPUT

      - name: 🧪 Health Check
        run: |
          echo "Waiting for services to be ready..."
          sleep 60
          
          echo "🌐 Production URLs:"
          echo "Frontend: ${{ steps.deploy.outputs.frontend-url }}"
          echo "API Gateway: ${{ steps.deploy.outputs.api-gateway-url }}"
          echo "User Service: ${{ steps.deploy.outputs.user-service-url }}"
          
          # Health checks
          curl -f "${{ steps.deploy.outputs.frontend-url }}/api/health" || exit 1
          curl -f "${{ steps.deploy.outputs.api-gateway-url }}/health" || exit 1
          curl -f "${{ steps.deploy.outputs.user-service-url }}/health" || exit 1
          
          echo "🎉 Production deployment completed successfully!"
          echo "🌟 Access your Hello World app at: ${{ steps.deploy.outputs.frontend-url }}"
