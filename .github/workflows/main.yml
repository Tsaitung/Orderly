name: ğŸš€ Orderly Hello World Deployment

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'orderly-472413' }}
  GCP_REGION: asia-east1

jobs:
  # =============================================================================
  # BUILD AND TEST
  # =============================================================================
  build:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    outputs:
      frontend-image: ${{ steps.build-frontend.outputs.image }}
      api-gateway-image: ${{ steps.build-api-gateway.outputs.image }}
      user-service-image: ${{ steps.build-user-service.outputs.image }}
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run tests (if available)
        run: npm run test --if-present

      - name: ğŸ” Run linting (if available)
        run: npm run lint --if-present

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ› ï¸ Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸ³ Configure Docker
        run: |
          gcloud auth configure-docker
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: ğŸ—ï¸ Build Frontend Image (root Next.js)
        id: build-frontend
        run: |
          IMAGE="us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly-docker/orderly-frontend:${{ github.sha }}"
          docker build -f Dockerfile.frontend -t $IMAGE .
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Build API Gateway Image
        id: build-api-gateway
        run: |
          IMAGE="us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly-docker/orderly-api-gateway:${{ github.sha }}"
          docker build -t $IMAGE ./backend/api-gateway
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Build User Service Image
        id: build-user-service
        run: |
          IMAGE="us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/orderly-docker/orderly-user-service:${{ github.sha }}"
          docker build -t $IMAGE ./backend/user-service
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

  # =============================================================================
  # DEPLOY TO STAGING
  # =============================================================================
  deploy-staging:
    name: ğŸš§ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging
    outputs:
      frontend-url: ${{ steps.deploy.outputs.frontend-url }}
      api-gateway-url: ${{ steps.deploy.outputs.api-gateway-url }}
      user-service-url: ${{ steps.deploy.outputs.user-service-url }}
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ› ï¸ Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸš€ Deploy Services
        id: deploy
        run: |
          # Deploy User Service
          gcloud run deploy orderly-user-service-staging \
            --image ${{ needs.build.outputs.user-service-image }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 10 \
            --min-instances 0 \
            --port 8001 \
            --set-env-vars NODE_ENV=staging,JWT_SECRET=${{ secrets.JWT_SECRET || 'staging-jwt-secret' }}

          USER_SERVICE_URL=$(gcloud run services describe orderly-user-service-staging --region=${{ env.GCP_REGION }} --format='value(status.url)')

          # Deploy API Gateway
          gcloud run deploy orderly-api-gateway-staging \
            --image ${{ needs.build.outputs.api-gateway-image }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10 \
            --min-instances 0 \
            --port 3000 \
            --set-env-vars NODE_ENV=staging,JWT_SECRET=${{ secrets.JWT_SECRET || 'staging-jwt-secret' }},USER_SERVICE_URL=$USER_SERVICE_URL

          API_GATEWAY_URL=$(gcloud run services describe orderly-api-gateway-staging --region=${{ env.GCP_REGION }} --format='value(status.url)')

          # Deploy Frontend
          gcloud run deploy orderly-frontend-staging \
            --image ${{ needs.build.outputs.frontend-image }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10 \
            --min-instances 0 \
            --port 8000 \
            --set-env-vars NODE_ENV=staging,NEXT_PUBLIC_API_BASE_URL=$API_GATEWAY_URL/api

          FRONTEND_URL=$(gcloud run services describe orderly-frontend-staging --region=${{ env.GCP_REGION }} --format='value(status.url)')

          echo "frontend-url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "api-gateway-url=$API_GATEWAY_URL" >> $GITHUB_OUTPUT
          echo "user-service-url=$USER_SERVICE_URL" >> $GITHUB_OUTPUT

      - name: ğŸ§ª Health Check
        run: |
          echo "Waiting for services to be ready..."
          sleep 30
          
          echo "ğŸŒ Staging URLs:"
          echo "Frontend: ${{ steps.deploy.outputs.frontend-url }}"
          echo "API Gateway: ${{ steps.deploy.outputs.api-gateway-url }}"
          echo "User Service: ${{ steps.deploy.outputs.user-service-url }}"
          
          # Health checks
          curl -f "${{ steps.deploy.outputs.frontend-url }}/api/health" || exit 1
          curl -f "${{ steps.deploy.outputs.api-gateway-url }}/health" || exit 1
          curl -f "${{ steps.deploy.outputs.user-service-url }}/health" || exit 1
          
          echo "âœ… All staging services are healthy!"

  # =============================================================================
  # DEPLOY TO PRODUCTION
  # =============================================================================
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    outputs:
      frontend-url: ${{ steps.deploy.outputs.frontend-url }}
      api-gateway-url: ${{ steps.deploy.outputs.api-gateway-url }}
      user-service-url: ${{ steps.deploy.outputs.user-service-url }}
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ› ï¸ Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸš€ Deploy Services
        id: deploy
        run: |
          # Deploy User Service
          gcloud run deploy orderly-user-service-prod \
            --image ${{ needs.build.outputs.user-service-image }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 2 \
            --max-instances 100 \
            --min-instances 1 \
            --port 8001 \
            --set-env-vars NODE_ENV=production,JWT_SECRET=${{ secrets.JWT_SECRET_PROD }}

          USER_SERVICE_URL=$(gcloud run services describe orderly-user-service-prod --region=${{ env.GCP_REGION }} --format='value(status.url)')

          # Deploy API Gateway
          gcloud run deploy orderly-api-gateway-prod \
            --image ${{ needs.build.outputs.api-gateway-image }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 2Gi \
            --cpu 2 \
            --max-instances 100 \
            --min-instances 1 \
            --port 3000 \
            --set-env-vars NODE_ENV=production,JWT_SECRET=${{ secrets.JWT_SECRET_PROD }},USER_SERVICE_URL=$USER_SERVICE_URL

          API_GATEWAY_URL=$(gcloud run services describe orderly-api-gateway-prod --region=${{ env.GCP_REGION }} --format='value(status.url)')

          # Deploy Frontend
          gcloud run deploy orderly-frontend-prod \
            --image ${{ needs.build.outputs.frontend-image }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 2Gi \
            --cpu 2 \
            --max-instances 100 \
            --min-instances 1 \
            --port 8000 \
            --set-env-vars NODE_ENV=production,NEXT_PUBLIC_API_BASE_URL=$API_GATEWAY_URL/api

          FRONTEND_URL=$(gcloud run services describe orderly-frontend-prod --region=${{ env.GCP_REGION }} --format='value(status.url)')

          echo "frontend-url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "api-gateway-url=$API_GATEWAY_URL" >> $GITHUB_OUTPUT
          echo "user-service-url=$USER_SERVICE_URL" >> $GITHUB_OUTPUT

      - name: ğŸ§ª Health Check
        run: |
          echo "Waiting for services to be ready..."
          sleep 60
          
          echo "ğŸŒ Production URLs:"
          echo "Frontend: ${{ steps.deploy.outputs.frontend-url }}"
          echo "API Gateway: ${{ steps.deploy.outputs.api-gateway-url }}"
          echo "User Service: ${{ steps.deploy.outputs.user-service-url }}"
          
          # Health checks
          curl -f "${{ steps.deploy.outputs.frontend-url }}/api/health" || exit 1
          curl -f "${{ steps.deploy.outputs.api-gateway-url }}/health" || exit 1
          curl -f "${{ steps.deploy.outputs.user-service-url }}/health" || exit 1
          
          echo "ğŸ‰ Production deployment completed successfully!"
          echo "ğŸŒŸ Access your Hello World app at: ${{ steps.deploy.outputs.frontend-url }}"
